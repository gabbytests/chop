<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Askbootstrap">
    <meta name="author" content="Askbootstrap">
    <link rel="icon" type="image/png" href="img/fav.png">
    <title>Chawmp - Your Cart</title>
    <!-- Slick Slider -->
    <link href="vendor/slick/slick/slick.css" rel="stylesheet" type="text/css">
    <link href="vendor/slick/slick/slick-theme.css" rel="stylesheet" type="text/css">
    <!-- Feather Icon-->
    <link href="vendor/icons/feather.css" rel="stylesheet" type="text/css">
    <!-- Bootstrap core CSS -->
    <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <!-- Custom styles for this template -->
    <link href="css/style.css" rel="stylesheet">
    <!-- Sidebar CSS -->
    <link href="vendor/sidebar/demo.css" rel="stylesheet">
    <!-- Additional Inline Styles for Nicer Look -->
    <style>
        .cart-section { padding: 20px; border-bottom: 1px solid #444; }
        .cart-section:last-child { border-bottom: none; }
        .cart-item { background: #2a2a2a; border-radius: 8px; padding: 15px; margin-bottom: 10px; }
        .cart-item p { margin-bottom: 0; }
        .section-title { font-size: 1.5rem; color: #fff; margin-bottom: 20px; }
        .delivery-details textarea { resize: none; height: 80px; background: #fff; border-radius: 5px; }
        .order-summary-box { background: #2a2a2a; border-radius: 8px; padding: 20px; margin-top: 20px; }
        .btn-success { font-size: 1.1rem; padding: 12px; }
        .btn-outline-primary { font-size: 1.1rem; padding: 12px; }
    </style>
</head>

<body class="fixed-bottom-bar">
    <div class="osahan-checkout">
        <div class="bg-primary border-bottom p-3 d-flex align-items-center">
            <h4 class="fw-bold m-0 text-white"><i class="feather-shopping-cart me-2"></i>Your Cart</h4>
            <a href="index.html" class="ms-auto text-white"><i class="feather-arrow-left"></i> Continue Shopping</a>
        </div>

        <div class="container position-relative">
            <div class="py-5 row">
                <div class="col-md-12">
                    <div id="cart-items" class="mb-3"></div>

                    <div class="order-summary-box">
                        <p class="mb-2 text-white">Subtotal <span class="float-end" id="subtotal">$0.00</span></p>
                        <p class="mb-2 text-white">Processing Fee <span class="float-end">$2.00</span></p>
                        <p class="mb-2 text-white">Delivery Fee <span class="float-end">$10.00</span></p>
                        <hr class="bg-light">
                        <h6 class="fw-bold mb-0 text-white">Total <span class="float-end" id="total">$0.00</span></h6>
                    </div>

                    <div class="pt-4">
                        <button id="checkout-btn" class="btn btn-success w-100">Proceed to Checkout <i class="feather-arrow-right"></i></button>

                        <a href="index.html" class="btn btn-outline-primary w-100 mt-2">Continue Shopping</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js";
        import { getFirestore, collection, getDocs, updateDoc, deleteDoc, doc, addDoc, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore.js";
    
        const firebaseConfig = {
            apiKey: "AIzaSyADvpUQWo75ExePGoCRirD2mM-lmfM4Cmc",
            authDomain: "von600-7982d.firebaseapp.com",
            projectId: "von600-7982d",
            storageBucket: "von600-7982d.appspot.com",
            messagingSenderId: "164591218045",
            appId: "1:164591218045:web:afe17512e16573e7903014",
            measurementId: "G-E69DMPLXBK"
        };
    
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
    
        // ✅ Enable Firestore Caching for Faster Loading
        enableIndexedDbPersistence(db).catch((err) => {
            console.warn("Firestore persistence failed:", err);
        });
    
        const cartItemsContainer = document.getElementById("cart-items");
        const subtotalContainer = document.getElementById("subtotal");
        const totalContainer = document.getElementById("total");
        const checkoutBtn = document.getElementById("checkout-btn");
    
        async function loadCart() {
            try {
                cartItemsContainer.innerHTML = "<p>Loading cart...</p>";
                const querySnapshot = await getDocs(collection(db, "cart"));
    
                let subtotal = 0;
                let output = "";
    
                if (querySnapshot.empty) {
                    cartItemsContainer.innerHTML = "<p class='text-white text-center'>Your cart is empty.</p>";
                    subtotalContainer.textContent = `$0.00`;
                    totalContainer.textContent = `$0.00`;
                    return;
                }
    
                querySnapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    const price = parseFloat(data.price) || 0;
                    const quantity = Math.max(1, parseInt(data.quantity) || 1);
                    const itemTotal = price * quantity;
                    subtotal += itemTotal;
    
                    output += `
                        <div class="cart-item d-flex justify-content-between align-items-center bg-dark p-3 mb-2 rounded">
                            <div>
                                <p class="m-0 fw-bold text-white">${data.name}</p>
                                <p class="text-white-50 small">$${price.toFixed(2)} each</p>
                            </div>
                            <div class="d-flex align-items-center">
                                <button class="btn-sm btn btn-outline-secondary decrease" data-id="${docSnap.id}"><i class="feather-minus"></i></button>
                                <span class="mx-2 text-white quantity" data-id="${docSnap.id}">${quantity}</span>
                                <button class="btn-sm btn btn-outline-secondary increase" data-id="${docSnap.id}"><i class="feather-plus"></i></button>
                                <p class="text-white mb-0 ms-3 fw-bold item-total" data-id="${docSnap.id}">$${itemTotal.toFixed(2)}</p>
                                <button class="btn-sm btn btn-danger ms-3 remove" data-id="${docSnap.id}"><i class="feather-trash-2"></i></button>
                            </div>
                        </div>
                    `;
                });
    
                cartItemsContainer.innerHTML = output;
                updateTotals(subtotal);
                addEventListeners();
            } catch (error) {
                console.error("❌ Error loading cart:", error);
                cartItemsContainer.innerHTML = "<p class='text-danger text-center'>Failed to load cart.</p>";
            }
        }
    
        function updateTotals(subtotal) {
            const processingFee = 2.00;
            const deliveryFee = 10.00;
            const total = subtotal + processingFee + deliveryFee;
    
            subtotalContainer.textContent = `$${subtotal.toFixed(2)}`;
            totalContainer.textContent = `$${total.toFixed(2)}`;
        }
    
        function addEventListeners() {
            document.querySelectorAll(".increase").forEach(button => {
                button.addEventListener("click", async () => {
                    const id = button.dataset.id;
                    const quantityElement = document.querySelector(`.quantity[data-id="${id}"]`);
                    let newQuantity = parseInt(quantityElement.textContent) + 1;
                    quantityElement.textContent = newQuantity;
    
                    await updateDoc(doc(db, "cart", id), { quantity: newQuantity });
                    loadCart();
                });
            });
    
            document.querySelectorAll(".decrease").forEach(button => {
                button.addEventListener("click", async () => {
                    const id = button.dataset.id;
                    const quantityElement = document.querySelector(`.quantity[data-id="${id}"]`);
                    let newQuantity = Math.max(1, parseInt(quantityElement.textContent) - 1);
                    quantityElement.textContent = newQuantity;
    
                    await updateDoc(doc(db, "cart", id), { quantity: newQuantity });
                    loadCart();
                });
            });
    
            document.querySelectorAll(".remove").forEach(button => {
                button.addEventListener("click", async () => {
                    const id = button.dataset.id;
                    await deleteDoc(doc(db, "cart", id));
                    loadCart();
                });
            });
    
            checkoutBtn.addEventListener("click", async () => {
    const querySnapshot = await getDocs(collection(db, "cart"));

    if (querySnapshot.empty) {
        alert("Your cart is empty!");
        return;
    }

    let orderItems = [];
    let totalAmount = 0;

    querySnapshot.forEach(docSnap => {
        const data = docSnap.data();
        if (!data.name || !data.price) return; // Skip invalid items

        const price = parseFloat(data.price) || 0;
        const quantity = Math.max(1, parseInt(data.quantity) || 1);
        const itemTotal = price * quantity;

        orderItems.push({ name: data.name, price, quantity, total: itemTotal });
        totalAmount += itemTotal;
    });

    const processingFee = 2.00;
    const deliveryFee = 10.00;
    totalAmount += processingFee + deliveryFee;

    await addDoc(collection(db, "orders"), {
        items: orderItems, // ✅ Always stores items as an array
        totalAmount,
        timestamp: new Date().toISOString()
    });

    querySnapshot.forEach(async (docSnap) => {
        await deleteDoc(doc(db, "cart", docSnap.id));
    });

    window.location.href = "successful.html";
});

        }
    
        document.addEventListener("DOMContentLoaded", loadCart);
    </script>
    
    
</body>


</html>