<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Restaurant Menu">
    <title>Restaurant</title>

    <!-- Preload Critical CSS -->
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" as="style" onload="this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"></noscript>

    <!-- Inline Critical CSS -->
    <style>
        body{font-family:'SF Pro Display',-apple-system,BlinkMacSystemFont,sans-serif;background:#565656;color:white;margin:0;padding:0;min-height:100vh;overflow-x:hidden}
        .restaurant-header{position:relative;height:300px;display:flex;align-items:center;justify-content:center;color:white;text-align:center;overflow:hidden}
        .restaurant-header img{width:100%;height:100%;object-fit:cover;filter:brightness(0.5)}
        .restaurant-info{position:absolute;text-align:center}
        .restaurant-info h1{font-size:2.5rem;font-weight:bold;margin-bottom:10px}
        .restaurant-info p{font-size:1.2rem;opacity:0.8}
        .menu-section{padding:50px 20px;max-width:600px;margin:auto;text-align:center}
        .menu-item{background:#3f3f3f;padding:15px;border-radius:12px;box-shadow:0 10px 20px rgba(0,0,0,0.05);margin-bottom:15px;display:flex;align-items:center;justify-content:space-between;transition:transform 0.2s ease-in-out}
        .menu-item:hover{transform:scale(1.02)}
        .menu-item h4{margin:0;font-size:1.2rem;font-weight:600;color:white}
        .menu-item p{margin:0;font-size:1rem;opacity:0.7;color:#fff}
        .add-to-cart{border:none;background:white;color:black;padding:8px 15px;border-radius:8px;font-size:1rem;transition:background 0.2s}
        .add-to-cart:hover{background:#ddd}
        .toast-container{position:fixed;top:20px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.85);color:white;padding:12px 20px;border-radius:12px;font-size:1rem;font-weight:500;display:flex;align-items:center;gap:10px;opacity:0;pointer-events:none;transition:opacity 0.4s ease,transform 0.4s ease}
        .toast-container.show{opacity:1;transform:translateX(-50%) translateY(10px);pointer-events:auto}
        .view-cart-btn{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:black;color:white;padding:16px 50px;border-radius:50px;font-size:1.2rem;font-weight:bold;text-decoration:none;transition:background 0.2s ease-in-out,opacity 0.2s ease-in-out;box-shadow:0 5px 15px rgba(0,0,0,0.2);opacity:0;visibility:hidden}
        .view-cart-btn.show{opacity:1;visibility:visible}
        .view-cart-btn:hover{background:#333}
        .back-arrow{position:absolute;top:20px;left:20px;background:rgba(0,0,0,0.647);color:white;padding:10px;border-radius:50%;transition:background 0.2s ease}
        .back-arrow:hover{background:rgba(0,0,0,0.8)}
        .menu-loading{font-size:1.5rem;font-weight:600;opacity:0.7;margin:0}
    </style>

    <!-- Defer Non-Critical JS -->
    <script defer src="https://unpkg.com/feather-icons"></script>
</head>
<body>
    <div class="restaurant-header">
        <img id="restaurant-image" loading="lazy">
        <button class="back-arrow" onclick="history.back()">
            <svg width="25" height="30" viewBox="0 0 24 24" stroke="white" stroke-width="3" fill="none" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="15 18 9 12 15 6"></polyline>
            </svg>
        </button>
        <div class="restaurant-info">
            <h1 id="restaurant-name">Preparing Your Feast...</h1>
            <p id="restaurant-info">Hang tight, deliciousness is on the way!</p>
        </div>
    </div>

    <div class="menu-section" id="menu-section">
        <p class="menu-loading">Heating up the menu... üç≤</p>
    </div>

    <div id="toast" class="toast-container">
        <div class="toast-content">
            <i data-feather="check-circle"></i>
            <span id="toast-message"></span>
        </div>
    </div>

    <a href="cart.html" class="view-cart-btn" id="view-cart-btn">View Cart</a>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, getDoc, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyADvpUQWo75ExePGoCRirD2mM-lmfM4Cmc",
            authDomain: "von600-7982d.firebaseapp.com",
            projectId: "von600-7982d",
            storageBucket: "von600-7982d.appspot.com",
            messagingSenderId: "164591218045",
            appId: "1:164591218045:web:afe17512e16573e7903014",
            measurementId: "G-E69DMPLXBK"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        enableIndexedDbPersistence(db).catch(err => console.warn("Firestore persistence failed:", err));

        const urlParams = new URLSearchParams(window.location.search);
        const restaurantId = urlParams.get("id");
        let cartCount = 0;

        async function loadRestaurant() {
            const start = performance.now();
            const docRef = doc(db, "restaurant", restaurantId);
            const docSnap = await getDoc(docRef);
            if (!docSnap.exists()) {
                document.getElementById("restaurant-name").textContent = "Restaurant Not Found";
                document.getElementById("restaurant-info").textContent = "";
                return;
            }
            const data = docSnap.data();
            requestAnimationFrame(() => {
                document.getElementById("restaurant-name").textContent = data.name;
                document.getElementById("restaurant-info").textContent = `‚≠ê ${data.rating} | ‚è≥ ${data.delivery_time} mins`;
                document.getElementById("restaurant-image").src = data.image;
            });
            console.log(`Restaurant loaded in ${(performance.now() - start).toFixed(2)}ms`);
        }

        async function loadMenu() {
            const start = performance.now();
            const menuRef = collection(db, "restaurant", restaurantId, "menu");
            const querySnapshot = await getDocs(menuRef);
            const menuItems = [];
            querySnapshot.forEach(docSnapshot => {
                const data = docSnapshot.data();
                menuItems.push({
                    id: docSnapshot.id,
                    name: data.name,
                    price: parseFloat(data.price) || 0
                });
            });
            renderMenu(menuItems);
            console.log(`Menu loaded in ${(performance.now() - start).toFixed(2)}ms`);
        }

        function renderMenu(items) {
            const menuSection = document.getElementById("menu-section");
            const fragment = document.createDocumentFragment();
            const menuList = document.createElement("div");
            menuList.id = "menu-list";
            items.forEach(item => {
                const div = document.createElement("div");
                div.className = "menu-item";
                div.innerHTML = `
                    <div>
                        <h4>${item.name}</h4>
                        <p>$${item.price.toFixed(2)}</p>
                    </div>
                    <button class="add-to-cart" 
                        data-id="${item.id}" 
                        data-name="${item.name}" 
                        data-price="${item.price}">
                        Add +
                    </button>
                `;
                menuList.appendChild(div);
            });
            const menuHeader = document.createElement("h2");
            menuHeader.className = "fw-bold";
            menuHeader.textContent = "Menu";
            fragment.appendChild(menuHeader);
            fragment.appendChild(menuList);
            requestAnimationFrame(() => {
                menuSection.innerHTML = "";
                menuSection.appendChild(fragment);
            });
        }

        function showToast(message) {
            const toast = document.getElementById("toast");
            document.getElementById("toast-message").textContent = message;
            requestAnimationFrame(() => {
                toast.classList.add("show");
                setTimeout(() => toast.classList.remove("show"), 2000);
            });
        }

        function updateCartButton() {
            const viewCartBtn = document.getElementById("view-cart-btn");
            requestAnimationFrame(() => {
                viewCartBtn.classList.toggle("show", cartCount > 0);
            });
        }

        function loadCartCount() {
            const cart = JSON.parse(localStorage.getItem("cart") || "[]");
            cartCount = cart.length;
            updateCartButton();
        }

        function addToCart(item) {
            const cart = JSON.parse(localStorage.getItem("cart") || "[]");
            cart.push(item);
            localStorage.setItem("cart", JSON.stringify(cart));
            cartCount++;
            updateCartButton();
            showToast(`${item.name} added to cart!`);
        }

        document.addEventListener("click", e => {
            if (e.target.classList.contains("add-to-cart")) {
                const item = {
                    name: e.target.dataset.name,
                    price: parseFloat(e.target.dataset.price),
                    restaurantId: restaurantId,
                    quantity: 1,
                    id: Date.now() // Unique ID for local cart
                };
                addToCart(item);
            }
        });

        document.addEventListener("DOMContentLoaded", async () => {
            const start = performance.now();
            await Promise.all([loadRestaurant(), loadMenu()]);
            loadCartCount();
            feather.replace();
            console.log(`Page fully loaded in ${(performance.now() - start).toFixed(2)}ms`);
        });
    </script>
</body>
</html>